from rest_framework import status
from rest_framework.response import Response
from rest_framework.decorators import api_view
from .serializers import RegistrationSerializer, GetUserSerializer, LoginSerializer
from ..models import *
from decouple import config
import binascii
import os
import bcrypt
import requests
from random import randrange
from datetime import datetime, timedelta
from django.utils.timezone import make_aware
from web3 import Web3
from web3.middleware import geth_poa_middleware
from django.http import HttpResponse
from pathlib import Path
import re

goerli_rpc_url = 'https://goerli.infura.io/v3/4108e6964fae4225b9f9c53f461e1cd4'
w3 = Web3(Web3.HTTPProvider(goerli_rpc_url))
queue_name = "A"
queue_A_count = 1
queue_B_count = 1
queue_C_count = 1
queue_D_count = 1
_current_active_date = None

contract_address_const = "0x6409596C6F8e112b5358CF9Ff5dBe8c7078a6035"
contract_abi_const = [{'inputs': [{'internalType': 'address', 'name': '_taptapCoinAddress', 'type': 'address'}, {'internalType': 'address', 'name': '_priceFeedAddress', 'type': 'address'}], 'stateMutability': 'nonpayable', 'type': 'constructor', 'name': 'constructor'}, {'anonymous': False, 'inputs': [{'indexed': False, 'internalType': 'string', 'name': '_message', 'type': 'string'}], 'name': 'CheckingEvent', 'type': 'event'}, {'anonymous': False, 'inputs': [{'indexed': True, 'internalType': 'address', 'name': 'previousOwner', 'type': 'address'}, {'indexed': True, 'internalType': 'address', 'name': 'newOwner', 'type': 'address'}], 'name': 'OwnershipTransferred', 'type': 'event'}, {'inputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'name': 'activePlayers', 'outputs': [{'internalType': 'address payable', 'name': '', 'type': 'address'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'addActivePlayer', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'newAccount', 'type': 'address'}, {'internalType': 'string', 'name': 'code', 'type': 'string'}], 'name': 'addWallet', 'outputs': [{'internalType': 'address payable[]', 'name': '', 'type': 'address[]'}], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'name': 'addresses', 'outputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'winner', 'type': 'address'}], 'name': 'awardTapTapCoin', 'outputs': [], 'stateMutability': 'payable', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'winner', 'type': 'address'}, {'internalType': 'uint256', 'name': 'percentage', 'type': 'uint256'}], 'name': 'calculateWinnings', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'checkForUser', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'checkUserFaceIdChecked', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'checkUserIsActive', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'string', 'name': 'str1', 'type': 'string'}, {'internalType': 'string', 'name': 'str2', 'type': 'string'}], 'name': 'compare', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'pure', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}, {'internalType': 'string', 'name': 'code', 'type': 'string'}, {'internalType': 'uint256', 'name': 'transaction_price', 'type': 'uint256'}], 'name': 'faceIdCheck', 'outputs': [{'components': [{'internalType': 'uint256', 'name': 'wins', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'games', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'waitTimeStart', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'faceIdCheck', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidUser', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidFaceId', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isActive', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isWinner', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isAboveZero', 'type': 'bool'}, {'internalType': 'bool', 'name': 'has100Games', 'type': 'bool'}, {'internalType': 'bool', 'name': 'skipping', 'type': 'bool'}, {'components': [{'internalType': 'uint256', 'name': 'addWalletTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'faceIdCheckTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_1', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_2', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_3', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'totalTransactionAmount', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'hasTotalTransactions', 'type': 'bool'}], 'internalType': 'struct TapCoinGame.TotalTransactions', 'name': 'totalTransactions', 'type': 'tuple'}], 'internalType': 'struct TapCoinGame.streakBoardValues', 'name': '', 'type': 'tuple'}], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [], 'name': 'getCurrentActualUsdOneCentCost', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'getPrice', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'getTotalTapTapCoinSupply', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}, {'internalType': 'uint256', 'name': 'dataIndex', 'type': 'uint256'}], 'name': 'getTransactionData', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'getUserStreakBoard', 'outputs': [{'components': [{'internalType': 'uint256', 'name': 'wins', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'games', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'waitTimeStart', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'faceIdCheck', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidUser', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidFaceId', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isActive', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isWinner', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isAboveZero', 'type': 'bool'}, {'internalType': 'bool', 'name': 'has100Games', 'type': 'bool'}, {'internalType': 'bool', 'name': 'skipping', 'type': 'bool'}, {'components': [{'internalType': 'uint256', 'name': 'addWalletTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'faceIdCheckTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_1', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_2', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_3', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'totalTransactionAmount', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'hasTotalTransactions', 'type': 'bool'}], 'internalType': 'struct TapCoinGame.TotalTransactions', 'name': 'totalTransactions', 'type': 'tuple'}], 'internalType': 'struct TapCoinGame.streakBoardValues', 'name': '', 'type': 'tuple'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'getUsersGamesCount', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'getUsersStreakCount', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'get_test_var', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'owner', 'outputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'name': 'playerIndexes', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address[]', 'name': 'users', 'type': 'address[]'}], 'name': 'removeActivePlayer', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [], 'name': 'renounceOwnership', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [], 'name': 'returnWinningsAmount', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'user', 'type': 'address'}], 'name': 'setUsersGamesTo100', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': '', 'type': 'address'}], 'name': 'streakBoard', 'outputs': [{'internalType': 'uint256', 'name': 'wins', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'games', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'waitTimeStart', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'faceIdCheck', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidUser', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isValidFaceId', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isActive', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isWinner', 'type': 'bool'}, {'internalType': 'bool', 'name': 'isAboveZero', 'type': 'bool'}, {'internalType': 'bool', 'name': 'has100Games', 'type': 'bool'}, {'internalType': 'bool', 'name': 'skipping', 'type': 'bool'}, {'components': [{'internalType': 'uint256', 'name': 'addWalletTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'faceIdCheckTransaction', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_1', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_2', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_3', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'totalTransactionAmount', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'hasTotalTransactions', 'type': 'bool'}], 'internalType': 'struct TapCoinGame.TotalTransactions', 'name': 'totalTransactions', 'type': 'tuple'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'taptapCoin', 'outputs': [{'internalType': 'contract IERC20', 'name': '', 'type': 'address'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'testFunction', 'outputs': [{'internalType': 'string', 'name': '', 'type': 'string'}], 'stateMutability': 'pure', 'type': 'function'}, {'inputs': [], 'name': 'testVar', 'outputs': [{'internalType': 'bool', 'name': '', 'type': 'bool'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'newOwner', 'type': 'address'}], 'name': 'transferOwnership', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'winner', 'type': 'address'}, {'internalType': 'address', 'name': 'loser', 'type': 'address'}, {'internalType': 'uint256', 'name': 'transaction_price_winner', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'transaction_price_loser', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'percentage', 'type': 'uint256'}], 'name': 'updatePlayersWins', 'outputs': [{'internalType': 'uint256', 'name': '', 'type': 'uint256'}], 'stateMutability': 'nonpayable', 'type': 'function'}]
contract_bytecode_const = "60c0604052601a60808190527f54454d504f5241525941444457414c4c455450415353434f444500000000000060a090815262000040916003919062000149565b506040805180820190915260138082527f54454d504f52415259464143454944434f4445000000000000000000000000006020909201918252620000879160049162000149565b50600580553480156200009957600080fd5b5060405162002ea138038062002ea1833981016040819052620000bc916200020c565b620000c733620000f9565b600180546001600160a01b039384166001600160a01b0319918216179091556002805492909316911617905562000280565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b828054620001579062000244565b90600052602060002090601f0160209004810192826200017b5760008555620001c6565b82601f106200019657805160ff1916838001178555620001c6565b82800160010185558215620001c6579182015b82811115620001c6578251825591602001919060010190620001a9565b50620001d4929150620001d8565b5090565b5b80821115620001d45760008155600101620001d9565b80516001600160a01b03811681146200020757600080fd5b919050565b600080604083850312156200022057600080fd5b6200022b83620001ef565b91506200023b60208401620001ef565b90509250929050565b600181811c908216806200025957607f821691505b6020821081036200027a57634e487b7160e01b600052602260045260246000fd5b50919050565b612c1180620002906000396000f3fe60806040526004361061019c5760003560e01c80638236e616116100ec578063b24f768c1161008a578063dbe13d7511610064578063dbe13d751461052c578063e16b4a9b14610642578063edf26d9b14610664578063f2fde38b1461068457600080fd5b8063b24f768c146104bf578063b55f108f146104df578063c28aafb1146104ff57600080fd5b806391628795116100c657806391628795146104115780639895ece41461043e57806398d5fdca146104535780639eee624a1461046857600080fd5b80638236e6161461039a57806382542aa9146103ba5780638da5cb5b146103f357600080fd5b80633a96fdd7116101595780636e6fe0ac116101335780636e6fe0ac146102e4578063715018a614610311578063745b4b3b146103265780637f4c77561461035e57600080fd5b80633a96fdd7146102845780634c10b79c146102a457806364a48696146102c457600080fd5b8063039e7a71146101a15780630f966112146101c95780631d3345f2146101e957806324a30c2514610219578063326418b71461023b5780633a0ef37114610271575b600080fd5b3480156101ad57600080fd5b506101b66106a4565b6040519081526020015b60405180910390f35b3480156101d557600080fd5b506101b66101e43660046123f7565b610717565b3480156101f557600080fd5b50610209610204366004612421565b61081d565b60405190151581526020016101c0565b34801561022557600080fd5b5061023961023436600461248a565b610845565b005b34801561024757600080fd5b506101b6610256366004612421565b6001600160a01b031660009081526007602052604090205490565b61023961027f366004612421565b610a57565b34801561029057600080fd5b5061020961029f3660046125a7565b610b32565b3480156102b057600080fd5b506101b66102bf366004612421565b610b9c565b3480156102d057600080fd5b506102096102df366004612421565b610bf6565b3480156102f057600080fd5b506103046102ff36600461260b565b610c1c565b6040516101c091906126be565b34801561031d57600080fd5b50610239610fd8565b34801561033257600080fd5b50600154610346906001600160a01b031681565b6040516001600160a01b0390911681526020016101c0565b34801561036a57600080fd5b50610209610379366004612421565b6001600160a01b031660009081526007602052604090206003015460ff1690565b3480156103a657600080fd5b506101b66103b5366004612785565b61103e565b3480156103c657600080fd5b506101b66103d5366004612421565b6001600160a01b031660009081526007602052604090206001015490565b3480156103ff57600080fd5b506000546001600160a01b0316610346565b34801561041d57600080fd5b506101b661042c366004612421565b60086020526000908152604090205481565b34801561044a57600080fd5b506101b6611932565b34801561045f57600080fd5b506101b661196d565b34801561047457600080fd5b50610239610483366004612421565b6001600160a01b031660009081526007602052604090206064600182015560038101805460ff60301b1916600160301b17905542600290910155565b3480156104cb57600080fd5b506101b66104da3660046123f7565b611a04565b3480156104eb57600080fd5b506103466104fa3660046127ed565b611b57565b34801561050b57600080fd5b5061051f61051a366004612806565b611b81565b6040516101c0919061284a565b34801561053857600080fd5b5061062a610547366004612421565b60076020818152600092835260409283902080546001820154600283015460038401548751610120810189526004860154815260058601549681019690965260068501549786019790975294830154606085015260088301546080850152600983015460a0850152600a83015460c0850152600b83015460e0850152600c9092015460ff908116151561010085810191909152919592949381841693928304821692620100008104831692630100000082048116926401000000008304821692650100000000008104831692600160301b8204811692600160381b90920416908c565b6040516101c09c9b9a99989796959493929190612897565b34801561064e57600080fd5b50610657611d82565b6040516101c0919061293b565b34801561067057600080fd5b5061034661067f3660046127ed565b611da2565b34801561069057600080fd5b5061023961069f366004612421565b611db2565b600154604080516318160ddd60e01b815290516000926001600160a01b0316916318160ddd9160048083019260209291908290030181865afa1580156106ee573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610712919061296e565b905090565b6001600160a01b0382166000908152600760205260408120600c015460ff1615156001146107c05760405162461bcd60e51b815260206004820152604560248201527f596f7520646f206e6f74206861766520612076616c6964207472616e7361637460448201527f696f6e20616d6f756e7420746f2063616c63756c617465207468652077696e6e60648201526434b733b99760d91b608482015260a4015b60405180910390fd5b6001600160a01b0383166000908152600760205260408120600b81015460058201546004909201549092916107f49161299d565b90506000610802828461299d565b905060006108108287611e7d565b9450505050505b92915050565b6001600160a01b03166000908152600760205260409020600301546301000000900460ff1690565b60005b8151811015610a535760076000838381518110610867576108676129b5565b60200260200101516001600160a01b03166001600160a01b0316815260200190815260200160002060030160019054906101000a900460ff1615610a41576000600860008484815181106108bd576108bd6129b5565b60200260200101516001600160a01b03166001600160a01b03168152602001908152602001600020549050600060016009805490506108fc91906129cb565b9050600060098281548110610913576109136129b5565b6000918252602082200154600980546001600160a01b0390921693509085908110610940576109406129b5565b600091825260209091200154600980546001600160a01b03909216925083918690811061096f5761096f6129b5565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b0316021790555083600860008888815181106109b4576109b46129b5565b60200260200101516001600160a01b03166001600160a01b031681526020019081526020016000208190555060086000826001600160a01b03166001600160a01b03168152602001908152602001600020600090556009805480610a1a57610a1a6129e2565b600082815260209020810160001990810180546001600160a01b0319169055019055505050505b80610a4b816129f8565b915050610848565b5050565b6001600160a01b038116600090815260086020526040812054600980549091908110610a8557610a856129b5565b60009182526020822001546040516001600160a01b0390911692508190839034908381818185875af1925050503d8060008114610ade576040519150601f19603f3d011682016040523d82523d6000602084013e610ae3565b606091505b509150915081610b2c5760405162461bcd60e51b81526020600482015260146024820152732330b4b632b2103a379039b2b7321022ba3432b960611b60448201526064016107b7565b50505050565b60008151835114610b4557506000610817565b81604051602001610b569190612a11565b6040516020818303038152906040528051906020012083604051602001610b7d9190612a11565b6040516020818303038152906040528051906020012014905092915050565b600980546001808201835560008381527f6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7af90920180546001600160a01b0319166001600160a01b03861617905591549091610817916129cb565b6001600160a01b0316600090815260076020526040902060030154610100900460ff1690565b610c2461231c565b610c60846040518060400160405280601a81526020017954454d504f5241525941444457414c4c455450415353434f444560301b815250611b81565b50600060048054610c7090612a2d565b80601f0160208091040260200160405190810160405280929190818152602001828054610c9c90612a2d565b8015610ce95780601f10610cbe57610100808354040283529160200191610ce9565b820191906000526020600020905b815481529060010190602001808311610ccc57829003601f168201915b50505050509050610cf985610bf6565b1515600114610d4a5760405162461bcd60e51b815260206004820152601f60248201527f54686973206163636f756e74206973206e6f7420726567697374657265642e0060448201526064016107b7565b610d538561081d565b1515600114610da45760405162461bcd60e51b815260206004820152601b60248201527f54686973206163636f756e74206973206e6f74206163746976652e000000000060448201526064016107b7565b610dae8482610b32565b610dfa5760405162461bcd60e51b815260206004820152601f60248201527f54686973206973206e6f7420612076616c6964207472616e73616374696f6e0060448201526064016107b7565b610e0385611ea5565b1515600114610e6e5760405162461bcd60e51b815260206004820152603160248201527f54686973206163636f756e74206973206e6f7420616c6c6f77656420746f20706044820152703630bc9030ba103a3434b9903a34b6b29760791b60648201526084016107b7565b50506001600160a01b0383166000908152600760208181526040928390206003810180546005830187905567ff000000000000ff191660019081179182905585516101808101875283548152838201548186015260028401548188015260608082019290925261010080840460ff90811615156080808501919091526201000086048216151560a080860191909152630100000087048316151560c08087019190915264010000000088048416151560e0808801919091526501000000000089048516151587870152600160301b89048516151561012080890191909152600160381b909904851615156101408801528c519889018d5260048a015489529988018d905260068901549b88019b909b529887015494860194909452600886015493850193909352600985015496840196909652600a84015496830196909652600b83015493820193909352600c909101549091161515918101919091526101608201529392505050565b6000546001600160a01b031633146110325760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016107b7565b61103c6000611f45565b565b600061107c876040518060400160405280601a81526020017954454d504f5241525941444457414c4c455450415353434f444560301b815250611b81565b506110b9866040518060400160405280601a81526020017954454d504f5241525941444457414c4c455450415353434f444560301b815250611b81565b506110ff876040518060400160405280601381526020017254454d504f52415259464143454944434f444560681b8152506e01ed09bead87c0378d8e6400000000610c1c565b50611145866040518060400160405280601381526020017254454d504f52415259464143454944434f444560681b8152506e01ed09bead87c0378d8e6400000000610c1c565b506001600160a01b038716600090815260076020526040812080546001929061116f90849061299d565b90915550506001600160a01b038716600090815260076020526040812080546001929061119d90849061299d565b90915550506001600160a01b03871660009081526007602052604081208054600192906111cb90849061299d565b90915550506001600160a01b03871660009081526007602052604081208054600192906111f990849061299d565b90915550506001600160a01b0387166000908152600760205260408120600190810180549192909161122c90849061299d565b90915550506001600160a01b0386166000908152600760205260408120600190810180549192909161125f90849061299d565b90915550506001600160a01b0387166000908152600760205260408120600190810180549192909161129290849061299d565b90915550506001600160a01b038616600090815260076020526040812060019081018054919290916112c590849061299d565b90915550506001600160a01b038716600090815260076020526040812060019081018054919290916112f890849061299d565b90915550506001600160a01b0386166000908152600760205260408120600190810180549192909161132b90849061299d565b90915550506001600160a01b0387166000908152600760205260408120600190810180549192909161135e90849061299d565b90915550506001600160a01b0386166000908152600760205260408120600190810180549192909161139190849061299d565b90915550506001600160a01b0380881660009081526007602081905260408083206e01ed09bead87c0378d8e6400000000600680830182905582850182905560088084018390556009938401839055968d16865292909420918201849055918101839055928301829055919091015561140987610bf6565b15156001146114695760405162461bcd60e51b815260206004820152602660248201527f5468652057696e6e696e67206163636f756e74206973206e6f742072656769736044820152653a32b932b21760d11b60648201526084016107b7565b61147286610bf6565b15156001146114d15760405162461bcd60e51b815260206004820152602560248201527f546865204c6f73696e67206163636f756e74206973206e6f742072656769737460448201526432b932b21760d91b60648201526084016107b7565b6114da8761081d565b15156001146115365760405162461bcd60e51b815260206004820152602260248201527f5468652057696e6e696e67206163636f756e74206973206e6f74206163746976604482015261329760f11b60648201526084016107b7565b61153f8661081d565b151560011461159a5760405162461bcd60e51b815260206004820152602160248201527f546865204c6f73696e67206163636f756e74206973206e6f74206163746976656044820152601760f91b60648201526084016107b7565b6001600160a01b03871660009081526007602052604090206003015460ff1615156001146116275760405162461bcd60e51b815260206004820152603460248201527f5468652057696e6e696e67206163636f756e7420646f6573206e6f7420686176604482015273329030903b30b634b2102922a1a0a82a21a4209760611b60648201526084016107b7565b6001600160a01b03861660009081526007602052604090206003015460ff1615156001146116b35760405162461bcd60e51b815260206004820152603360248201527f546865204c6f73696e67206163636f756e7420646f6573206e6f7420686176656044820152721030903b30b634b2102922a1a0a82a21a4209760691b60648201526084016107b7565b6116bc87611ea5565b61172e5760405162461bcd60e51b815260206004820152603860248201527f5468652057696e6e696e67206163636f756e74206973206e6f7420616c6c6f7760448201527f656420746f20706c617920617420746869732074696d652e000000000000000060648201526084016107b7565b61173786611ea5565b6117a95760405162461bcd60e51b815260206004820152603760248201527f546865204c6f73696e67206163636f756e74206973206e6f7420616c6c6f776560448201527f6420746f20706c617920617420746869732074696d652e00000000000000000060648201526084016107b7565b6001600160a01b03808816600081815260076020526040808220600c808201805460ff19908116909155958c1684529183209091018054909416909355908152815460019291906117fb90849061299d565b90915550506001600160a01b038087166000908152600760205260408082208290559189168152908120600190810180549192909161183b90849061299d565b90915550506001600160a01b0386166000908152600760205260408120600190810180549192909161186e90849061299d565b90915550506001600160a01b038088166000908152600760205260408082206003908101805464ff000000001990811664010000000017909155938a168352912001805490911690556118c18786611f95565b6118cb8685611f95565b821561191a576005546001600160a01b0388166000908152600760205260409020541061191a5760006118fe8884610717565b905061190a8888612100565b61191388610a57565b9050611928565b6119248787612100565b5060015b9695505050505050565b6000662386f26fc10000670de0b6b3a76400008261194e61196d565b90508061195b8385612a67565b6119659190612a9c565b935050505090565b600080600260009054906101000a90046001600160a01b03166001600160a01b031663feaf968c6040518163ffffffff1660e01b815260040160a060405180830381865afa1580156119c3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119e79190612aca565b505050915050806402540be4006119fe9190612b1a565b91505090565b600081600003611a3057506001600160a01b038216600090815260076020526040902060040154610817565b81600103611a5a57506001600160a01b038216600090815260076020526040902060050154610817565b81600203611a8457506001600160a01b038216600090815260076020526040902060060154610817565b81600303611aaf57506001600160a01b03821660009081526007602081905260409091200154610817565b81600403611ad957506001600160a01b038216600090815260076020526040902060080154610817565b81600503611b0357506001600160a01b038216600090815260076020526040902060090154610817565b81600603611b2d57506001600160a01b0382166000908152600760205260409020600a0154610817565b8160070361081757506001600160a01b0382166000908152600760205260409020600b0154610817565b60098181548110611b6757600080fd5b6000918252602090912001546001600160a01b0316905081565b6060600060038054611b9290612a2d565b80601f0160208091040260200160405190810160405280929190818152602001828054611bbe90612a2d565b8015611c0b5780601f10611be057610100808354040283529160200191611c0b565b820191906000526020600020905b815481529060010190602001808311611bee57829003601f168201915b50505050509050611c1c8382610b32565b611c685760405162461bcd60e51b815260206004820152601f60248201527f54686973206973206e6f7420612076616c6964207472616e73616374696f6e0060448201526064016107b7565b6001600160a01b0384166000908152600760205260408120908155600301805463ff00ffff19166301000100179055611c9f611932565b6001600160a01b038516600090815260076020819052604082206004810193909355600583018290556006830182905582018190556008820181905560098201819055600a82018190556003909101805460ff60301b19169055611d0285610b9c565b6001600160a01b03861660009081526008602090815260409182902083905560098054835181840281018401909452808452939450919290830182828015611d7357602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311611d55575b50505050509250505092915050565b6060604051806060016040528060288152602001612bb460289139905090565b60068181548110611b6757600080fd5b6000546001600160a01b03163314611e0c5760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016107b7565b6001600160a01b038116611e715760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016107b7565b611e7a81611f45565b50565b600080611e9183662386f26fc10000612a67565b9050611e9d8185612a9c565b949350505050565b6001600160a01b038116600090815260076020526040812060030154600190600160301b900460ff16611edb5750600192915050565b6001600160a01b038316600090815260076020526040902060020154611f0290829061299d565b4210611f3c5750506001600160a01b0316600090815260076020526040812060038101805460ff60301b1916905560019081019190915590565b50600092915050565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6001600160a01b03821660009081526007602052604081206001810154600390910154909190600160381b900460ff1661209a576006821015611fe457611fdd6001836129cb565b9050612060565b600982111561203357611ff8600583612b9f565b60000361202857506001600160a01b0383166000908152600760205260408120600301805460ff19169055612060565b611fdd60018261299d565b6001600160a01b0384166000908152600760205260409020600301805460ff60381b1916600160381b1790555b6001600160a01b038416600090815260076020526040902060030154600160381b900460ff16612095576120958484836121b3565b610b2c565b6001600160a01b03841660009081526007602052604090206001908101546005916120c5919061299d565b6120cf9190612b9f565b600003610b2c575050506001600160a01b03166000908152600760205260409020600301805460ff60381b19169055565b6001600160a01b038216600090815260076020526040902060010154606403612158576001600160a01b038216600090815260076020526040902060038101805460ff60301b1916600160301b179055426002909101555b6001600160a01b038116600090815260076020526040902060010154606403610a53576001600160a01b038116600090815260076020526040902060038101805460ff60301b1916600160301b179055426002909101555050565b806000036121de576001600160a01b0383166000908152600760205260409020600601829055612287565b8060010361220a576001600160a01b038316600090815260076020819052604090912001829055612287565b80600203612235576001600160a01b0383166000908152600760205260409020600801829055612287565b80600303612260576001600160a01b0383166000908152600760205260409020600901829055612287565b80600403612287576001600160a01b0383166000908152600760205260409020600a018290555b6001600160a01b0383166000908152600760208190526040909120600a81015460098201546008830154938301546006909301549193909290916122cb919061299d565b6122d5919061299d565b6122df919061299d565b6122e9919061299d565b6001600160a01b039093166000908152600760205260409020600b8101939093555050600c01805460ff19166001179055565b6040518061018001604052806000815260200160008152602001600081526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020016000151581526020016123d660405180610120016040528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000151581525090565b905290565b80356001600160a01b03811681146123f257600080fd5b919050565b6000806040838503121561240a57600080fd5b612413836123db565b946020939093013593505050565b60006020828403121561243357600080fd5b61243c826123db565b9392505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561248257612482612443565b604052919050565b6000602080838503121561249d57600080fd5b823567ffffffffffffffff808211156124b557600080fd5b818501915085601f8301126124c957600080fd5b8135818111156124db576124db612443565b8060051b91506124ec848301612459565b818152918301840191848101908884111561250657600080fd5b938501935b8385101561252b5761251c856123db565b8252938501939085019061250b565b98975050505050505050565b600082601f83011261254857600080fd5b813567ffffffffffffffff81111561256257612562612443565b612575601f8201601f1916602001612459565b81815284602083860101111561258a57600080fd5b816020850160208301376000918101602001919091529392505050565b600080604083850312156125ba57600080fd5b823567ffffffffffffffff808211156125d257600080fd5b6125de86838701612537565b935060208501359150808211156125f457600080fd5b5061260185828601612537565b9150509250929050565b60008060006060848603121561262057600080fd5b612629846123db565b9250602084013567ffffffffffffffff81111561264557600080fd5b61265186828701612537565b925050604084013590509250925092565b805182526020810151602083015260408101516040830152606081015160608301526080810151608083015260a081015160a083015260c081015160c083015260e081015160e083015261010080820151151581840152505050565b60006102808201905082518252602083015160208301526040830151604083015260608301516126f2606084018215159052565b506080830151612706608084018215159052565b5060a083015161271a60a084018215159052565b5060c083015161272e60c084018215159052565b5060e083015161274260e084018215159052565b506101008381015115159083015261012080840151151590830152610140808401511515908301526101608084015161277d82850182612662565b505092915050565b60008060008060008060c0878903121561279e57600080fd5b6127a7876123db565b95506127b5602088016123db565b94506040870135935060608701359250608087013580151581146127d857600080fd5b8092505060a087013590509295509295509295565b6000602082840312156127ff57600080fd5b5035919050565b6000806040838503121561281957600080fd5b612822836123db565b9150602083013567ffffffffffffffff81111561283e57600080fd5b61260185828601612537565b6020808252825182820181905260009190848201906040850190845b8181101561288b5783516001600160a01b031683529284019291840191600101612866565b50909695505050505050565b8c8152602081018c9052604081018b90528915156060820152881515608082015287151560a082015286151560c082015285151560e082015284151561010082015261028081018415156101208301528315156101408301526128fe610160830184612662565b9d9c50505050505050505050505050565b60005b8381101561292a578181015183820152602001612912565b83811115610b2c5750506000910152565b602081526000825180602084015261295a81604085016020870161290f565b601f01601f19169190910160400192915050565b60006020828403121561298057600080fd5b5051919050565b634e487b7160e01b600052601160045260246000fd5b600082198211156129b0576129b0612987565b500190565b634e487b7160e01b600052603260045260246000fd5b6000828210156129dd576129dd612987565b500390565b634e487b7160e01b600052603160045260246000fd5b600060018201612a0a57612a0a612987565b5060010190565b60008251612a2381846020870161290f565b9190910192915050565b600181811c90821680612a4157607f821691505b602082108103612a6157634e487b7160e01b600052602260045260246000fd5b50919050565b6000816000190483118215151615612a8157612a81612987565b500290565b634e487b7160e01b600052601260045260246000fd5b600082612aab57612aab612a86565b500490565b805169ffffffffffffffffffff811681146123f257600080fd5b600080600080600060a08688031215612ae257600080fd5b612aeb86612ab0565b9450602086015193506040860151925060608601519150612b0e60808701612ab0565b90509295509295909350565b60006001600160ff1b0381841382841380821686840486111615612b4057612b40612987565b600160ff1b6000871282811687830589121615612b5f57612b5f612987565b60008712925087820587128484161615612b7b57612b7b612987565b87850587128184161615612b9157612b91612987565b505050929093029392505050565b600082612bae57612bae612a86565b50069056fe43414c4c494e472054484520544553542046554e4354494f4e20494e20544150434f494e47414d45a2646970667358221220007d35869ca1c4317d5fb4c819e6e9bc8ff3e4fda3836fe590511cd82e84096c64736f6c634300080e0033"
w3.middleware_onion.inject(geth_poa_middleware, layer=0)

@api_view(['POST'])
def registration_view(request):
    if request.method == 'POST':
        serializer = RegistrationSerializer(data=request.data)
        data = {}
        if serializer.is_valid():
            user = serializer.save()
            if type(user) == str:
                data["error"] = user
                data["isErr"] = True
                return Response(data)
            data['response'] = "Success"
            data['username'] = user.username
            user1 = User.objects.get(username=data['username'])
            token = user1.token
            data['token'] = token.token
            user1.in_game = False
            user1.in_queue = False
            user1.logged_in = True
            if request.data['phone_number'] != "":
                validate_phone_number_pattern = "^\\+?[1-9][0-9]{7,14}$"
                is_valid_phone_number = re.match(validate_phone_number_pattern, request.data['phone_number'])
                print("IS VALID PHONE NUMBER BELOW")
                print(is_valid_phone_number)
                if is_valid_phone_number:
                    user1.phone_number = request.data['phone_number']
                    user1.has_phone_number = True
                else:
                    user1.delete()
                    data = {
                        "response": "Invalid phone number.",
                        "token": "Invalid.",
                        "username": "Invalid."
                    }
                    return Response(data)
            user1.save()
        else:
            data = serializer.errors
        return Response(data)

@api_view(['POST'])
def login_view(request):
    serializer = LoginSerializer(data=request.data)

    data = {}
    if serializer.is_valid():
        user = serializer.save()
        if type(user) == dict:
            return Response(user)
        data['response'] = "Success"
        data['username'] = user.username
        user1 = User.objects.get(username=user.username)
        if user1.logged_in:
            newData = {
                'log_in_error': "User already logged in."
            }
            return Response(newData)
        user1.in_game = False
        user1.in_queue = False
        user1.logged_in = True
        user1.save()
        token = binascii.hexlify(os.urandom(config('TOKEN', cast=int))).decode()
        token1 = user1.token
        token1.token = token
        token1.save()
        data['token'] = token
    else:
        data = serializer.errors
    return Response(data)

@api_view(['POST'])
def get_user(request):
    print("IN GET USER")
    newData = {
        "token": request.data['token']
    }
    print(newData)
    de_queue = request.data['de_queue']
    from_val = None
    if request.data['from']:
        from_val = request.data['from']
    
    serializer = GetUserSerializer(data=newData)

    data = {}

    if serializer.is_valid():
        print("SERIALIZER VALID")
        user = serializer.save()
        data['response'] = "Getting your information"
        data['username'] = user.username
        if user.first_name:
            data['first_name'] = user.first_name
        else:
            data['first_name'] = ""
        if user.last_name:
            data['last_name'] = user.last_name
        else:
            data['last_name'] = ""
        try:
            print("IN TRY BLOCK")
            data['wins'] = user.wins
            data['losses'] = user.losses
            data['best_streak'] = user.best_streak
            data['win_streak'] = user.win_streak
        except:
            print("IN EXCEPT BLOCK")
            pass
        active_friends_index_list = []
        if type(user.friends) == list:
            print("USER HAS FRIENDS")
            friend_names = []
            index_count = 0
            for friend_id in user.friends:
                friend = FriendModel.objects.get(id=friend_id)
                temp_friend = None
                if user.username == friend.sending_user:
                    temp_friend = User.objects.get(username=friend.receiving_user)
                    if friend.pending_request:
                        friend_line = "Pending request to " + friend.receiving_user
                        friend_names.append(friend_line)
                    else:
                        friend_names.append(friend.receiving_user)
                else:
                    temp_friend = User.objects.get(username=friend.sending_user)
                    if friend.pending_request:
                        friend_line = "Friend request from " + friend.sending_user
                        friend_names.append(friend_line)
                    else:
                        friend_names.append(friend.sending_user)
                if temp_friend.is_active:
                    active_friends_index_list.append(index_count)
                index_count += 1
            data['friends'] = friend_names
            data['active_friends_index_list'] = active_friends_index_list
        else:
            print("USER HAS 0 FRIENDS")
            data['friends'] = ["0"]
        hasInvites = False
        invites = []
        for invite in GameInvite.objects.all():
            if invite.reciever == user.username:
                print("USER HAS INVITES")
                hasInvites = True
                invites.append(invite.sender)
        data['hasInvite'] = hasInvites
        data['invites'] = invites
        data['is_guest'] = user.is_guest
        data['has_wallet'] = user.has_wallet
        if user.phone_number:
            print("USER HAS PHONE NUMBER")
            data['phone_number'] = user.phone_number
            user.has_phone_number = True
            data['HPN'] = True
            user.save()
        else:
            print("USER HAS NO PHONE NUMBER")
            data['phone_number'] = "No Phone number"
            data['HPN'] = False
        user.last_active_date = datetime.now()
        user.is_active = True
        user.save()
        if from_val == "Home":
            if user.has_location == True:
                print("USER HAS LOCATION")
                data['has_location'] = True
            else:
                print("USER DOES NOT HAVE LOCATION")
                data['has_location'] = False
        
        users_games = user.wins + user.losses
        if users_games >= 25:
            print("USER HAS MORE THAN 25 GAMES")
            league_placement_val = league_placement(user.wins, users_games)
            print("GOT THE LEAGUE PLACEMENT")
            print(league_placement_val)
            if league_placement_val:
                print("LEAGUE PLACEMENT IS NOT NULL")
                user.league = league_placement_val
                user.save()
                data['league_placement'] = league_placement_val
        else:
            print("USER DOES NOT HAVE MORE THAN 25 GAMES")
            data['league_placement']  = 1
        # _current_active_date = datetime.now()
        # check_all_users_active()
    else: 
        print("SERIALIZER ERRORS")
        data = serializer.errors
    print("DATA BELOW")
    print(data)
    if de_queue:
        user.in_queue = False
        user.in_game = False
        user.save()
    return Response(data)

# def check_all_users_active():
#     all_users = User.objects.all()
#     print("IN CHECK FOR ALL ACTIVE USERS")
#     if _current_active_date != None:
#         print("CURRENT ACTIVE DATE DOES NOT EQUAL NONE")
#         COMP_TIME = _current_active_date - timedelta(minutes=3)
#         for user in all_users:
#             if user.is_active:
#                 if user.last_active_date < COMP_TIME:
#                     user.is_active = False
#                     user.save()
#                 else:
#                     print("USERS TIME IS FINE")
#             else:
#                 print("USER IS NOT ACTIVE")

@api_view(['POST'])
def logout_view(request):
    session = request.data['token']
    
    data = {}

    token1 = None
    try:
        for token in Token.objects.all():
            if token.token == session:
                token1 = token
        data['response'] = "Success"
    except:
        data['response'] = "Failure"
        return Response(data)
    user = User.objects.get(token=token1)
    if user.is_guest:
        token1.delete()
        user.delete()
    else:
        user.logged_in = False
        user.in_queue = False
        user.in_game = False
        user.is_active = False
        user.save()
        token1.token = "null"
        token1.save()
    return Response(data)

@api_view(['POST'])
def send_points(request):
    print("***** IN SEND POINTS *****")
    print("***** " + request.data['location'] + "*****")
    if request.data['count'] > 1:
        print("COUNT IS GREATER THAN 1")
        return

    if request.data['type'] == "Custom":
        print("CUSTOM IS TRUE")
        data = {
            "gameOver" : True
        }
        return Response(data)

    if request.data['winner'] == False:
        print("WINNER IS FALSE")
        data = {
            "gameOver" : True
        }
        return Response(data)

    fPoints = request.data['fPoints']
    sPoints = request.data['sPoints']
    gameId = request.data['gameId']
    game = Game.objects.get(gameId=gameId)
    user1 = User.objects.get(username=game.first)
    user2 = User.objects.get(username=game.second)
    right_now = make_aware(datetime.now())
    
    if fPoints > sPoints:
        print("***** FPOINTS IS GREATER *****")
        user1.wins += 1

        if user1.streak_time:
            print("USER 1 HAS A STREAK TIME")
            time_limit = user1.streak_time + timedelta(minutes=2)
            if right_now < time_limit:
                print("STILL WITHIN THE TIME LIMITS")
                user1.win_streak += 1
            else:
                print("NOT WITHIN THE TIME LIMITS")
                user1.win_streak = 1
        else:
            print("NO STREAK TIME")
            user1.win_streak = 1 

        if user1.win_streak > user1.best_streak:
            print("NEW BEST STREAK")
            user1.best_streak = user1.win_streak

        user1.streak_time = right_now
        user1.save()
        user2.losses += 1
        if user2.win_streak > user2.best_streak:
            user2.best_streak = user2.win_streak
        user2.win_streak = 0
        user2.save()
        game.fPoints = fPoints
        game.sPoints = sPoints
        game.winner = user1.username
        game.winner_streak = user1.win_streak
        game.save()
    elif sPoints > fPoints:
        print("***** SPOINTS IS GREATER *****")
        user1.losses += 1
        if user1.win_streak > user1.best_streak:
            user1.best_streak = user1.win_streak
        user1.win_streak = 0
        user1.save()
        user2.wins += 1
        if user2.streak_time:
            print("USER 2 HAS A STREAK TIME")
            time_limit = user2.streak_time + timedelta(minutes=2)
            if right_now < time_limit:
                print("STILL WITHIN THE TIME LIMITS")
                user2.win_streak += 1
            else:
                print("NOT WITHIN TIME LIMITS")
                user2.win_streak = 1
        else:
            print("NO STREAK TIME")
            user2.win_streak = 1
        if user2.win_streak > user2.best_streak:
            print("NEW BEST STREAK")
            user2.best_streak = user2.win_streak
        user2.streak_time = right_now
        user2.save()
        game.fPoints = fPoints
        game.sPoints = sPoints
        game.winner = user2.username
        game.winner_streak = user2.win_streak
        game.save()
    else:
        print("***** IT IS A TIE *****")
        print("STOP")
        game.fPoints = fPoints
        game.sPoints = sPoints
        game.winner = "Tie"
        game.winner_streak = 0
        game.save()
    
    if user1.has_wallet and user2.has_wallet:
        print("BEFORE UPDATE PLAYERS WINS")
        update_players_wins()
        print("AFTER UPDATE PLAYERS WINS")
    else:
        print("NO WALLETS")
    data = {
        "gameOver" : True
    }
    return Response(data)

@api_view(['POST'])
def create_game(request):
    
    token = Token.objects.get(token=request.data['token'])
    token1 = Token.objects.get(token=request.data['first'])
    token2 = Token.objects.get(token=request.data['second'])
    user = User.objects.get(token=token)
    user1 = User.objects.get(token=token1)
    user2 = User.objects.get(token=token2)

    data = {}

    if user.in_game == False:
        gameId = binascii.hexlify(os.urandom(8)).decode()
        Game.objects.create(first=user1.username, second=user2.username, gameId=gameId)
        user1.cg_Id = gameId
        user2.cg_Id = gameId
        user1.in_game = True
        user2.in_game = True
        user1.save()
        user2.save()
        data['gameId'] = gameId
        data['first'] = "True"
    else:
        data['gameId'] = user2.cg_Id
        data['first'] = "False"
        user1.in_game = False
        user2.in_game = False
        user1.save()
        user2.save()

    return Response(data)

@api_view(['POST'])
def guest_login(request):
    data = {}
    token = binascii.hexlify(os.urandom(config('TOKEN', cast=int))).decode()
    pw = "guestPassword"
    salt = bcrypt.gensalt(rounds=config('ROUNDS', cast=int))
    hashed = bcrypt.hashpw(pw.encode(config('ENCODE')), salt).decode()
    token1 = Token.objects.create(token=token)
    count = 0
    for user in User.objects.all():
        try:
            if user.username.split("_")[0] == "CoinTapper":
                count += 1
        except:
            count = count

    newCount = str(count)
    user = None
    try:
        user = User.objects.create(first_name="Guest",last_name="Tapper", username="CoinTapper_" + newCount, token=token1, password=hashed)
        user.is_guest = True
        user.in_game = False
        user.in_queue = False
        user.logged_in = True
        user.save()
        data['response'] = "succesfully registered a new guest user."
        data['username'] = user.username
        data['error'] = False
        data['token'] = token1.token
    except Exception as e:
        newError = str(e)
        newErr = newError.split("DETAIL:")[1]
        error = newErr.split("=")[1]
        data['response'] = "Something went wrong."
        data['username'] = error
        data['error'] = True
        data['token'] = ""
        return Response(data)

    return Response(data)

@api_view(['POST'])
def send_cb(request):
    tToken = request.data['token']
    token = Token.objects.get(token=tToken)
    user = User.objects.get(token=token)

    CommentOrBug.objects.create(message=request.data['text'], user=user.username)

    data={
        'response':'Successfully Sent'
    }

    return Response(data)

@api_view(['POST'])
def check_in_game(request):

    tk = request.data['token']
    token = Token.objects.get(token=tk)
    user = User.objects.get(token=token)
    data = {}
    if user.in_game:
        data['response'] = "INGAME"
    else:
        data['response'] = "OUTGAME"

    return Response(data)

@api_view(['POST'])
def send_friendRequest(request):
    try:
        print("IN SEND FRIEND REQUEST")
        print("1")
        token1 = Token.objects.get(token=request.data['token'])
        print("2")
        user1 = User.objects.get(token=token1)
        print("3")
        user2 = User.objects.get(username=request.data['username'])
        print("4")
        if user1 == user2:
            print("5")
            data = {
                "result": "Cannot send request to self.",
                "friends": "No friends"
            }
            return Response(data)
        # Check if FriendModel already created with both usernames
        users_usernames_type1 = user1.username + user2.username
        users_usernames_type2 = user2.username + user1.username
        print("6")
        try:
            print("7")
            FriendModel.objects.get(users_names_string=users_usernames_type1)
            data = {
                    "result": "Already created a friend request with: ",
                    "friends": user2.username
                }
            return Response(data)
        except:
            print("8")
            try:
                print("9")
                FriendModel.objects.get(users_names_string=users_usernames_type2)
                data = {
                    "result": "Already created a friend request with: ",
                    "friends": user2.username
                }
                return Response(data)
            except:
                print("10")
                pass
        print("11")
        # Create FriendModel with both user names | make pending_request True
        new_friend_model = FriendModel.objects.create(sending_user=user1.username, receiving_user=user2.username, pending_request=True, users_names_string=users_usernames_type1)
        print("12")
        # Capture FriendModel Id
        new_friend_model_id = new_friend_model.id
        print("13")
        # Save FriendModel Id in both users friends list
        if user1.friends:
            print("14")
            user1.friends.append(new_friend_model_id)
        else:
            print("15")
            user1_friends = [new_friend_model_id] 
            user1.friends = user1_friends
        if user2.friends:
            print("16")
            user2.friends.append(new_friend_model_id)
        else:
            print("17")
            user2_friends = [new_friend_model_id] 
            user2.friends = user2_friends
        print("18")
        user1.save()
        user2.save()
        print("19")
        data = {
            "result": "Success",
            "friends": user2.username
        }
        return Response(data)
    except Exception as e:
        print("20")
        print(e)
        data = {
            "result": "Could not find username.",
            "friends": "No friends"
        }
        return Response(data)

@api_view(['POST'])
def accept_friendRequest(request):
    try:
        token1 = Token.objects.get(token=request.data['token'])
        accepter = User.objects.get(token=token1)
        sender = User.objects.get(username=request.data['username'])
        # Get friend model based on usernames
        users_usernames = sender.username + accepter.username
        friend_model = FriendModel.objects.get(users_names_string=users_usernames)
        # Adjust pending_request attribute to False
        friend_model.pending_request = False
        # Save Friend Model
        friend_model.save()
        data = {
            "result": "Accepted"
        }
        return Response(data)
    except:
        data = {
            "result": "Colud not accept request"
        }
        return Response(data)

@api_view(['POST'])
def decline_friendRequest(request):
    try:
        token1 = Token.objects.get(token=request.data['token'])
        decliner = User.objects.get(token=token1)
        sender = User.objects.get(username=request.data['username'])
        users_usernames = sender.username + decliner.username
        friend_model = FriendModel.objects.get(users_names_string=users_usernames)
        sender.friends.pop(sender.friends.index(friend_model.id))
        decliner.friends.pop(decliner.friends.index(friend_model.id))
        friend_model.delete()
        sender.save()
        decliner.save()
        data = {
            "result": "Declined"
        }
        return Response(data)
    except:
        data = {
            "result": "Colud not decline request."
        }
        return Response(data)

@api_view(['POST'])
def remove_friend(request):
    try:
        token1 = Token.objects.get(token=request.data['token'])
        remover = User.objects.get(token=token1)
        removed = User.objects.get(username=request.data['username'])
        users_usernames_type1 = remover.username + removed.username
        users_usernames_type2 = removed.username + remover.username
        friend_model = None
        try:
            friend_model = FriendModel.objects.get(users_names_string=users_usernames_type1)
        except:
            try:
                friend_model = FriendModel.objects.get(users_names_string=users_usernames_type2)
            except:
                data = {
                    "result": "Could not remove friend."
                }
                return Response(data)
        remover.friends.pop(remover.friends.index(friend_model.id))
        removed.friends.pop(removed.friends.index(friend_model.id))
        friend_model.delete()
        remover.save()
        removed.save()
        data = {
            "result": "Removed"
        }
        return Response(data)
    except:
        data = {
            "result": "Could not remove friend."
        }
        return Response(data)

@api_view(['POST'])
def send_invite(request):
    token = Token.objects.get(token=request.data['token'])
    user1 = User.objects.get(token=token)
    user2 = User.objects.get(username=request.data['username'])
    gameId = binascii.hexlify(os.urandom(8)).decode()
    uniqueId = False
    while(not uniqueId):
        foundId = False
        for game in Game.objects.all():
            if game.gameId == gameId:
                foundId = True
                break
        if foundId:
            gameId = binascii.hexlify(os.urandom(8)).decode()
        else:
            uniqueId = True
    for gInvite in GameInvite.objects.all():
        if gInvite.sender == user1.username:
            if gInvite.reciever == user2.username:
                data = {
                    "first": "ALREADY EXISTS",
                    "second": "ALREADY EXISTS",
                    "gameId": "ALREADY EXISTS"
                }
                return Response(data)
        elif gInvite.sender == user2.username:
            if gInvite.reciever == user1.username:
                data = {
                    "first": "ALREADY EXISTS",
                    "second": "ALREADY EXISTS",
                    "gameId": "ALREADY EXISTS"
                }
                return Response(data)
    GameInvite.objects.create(sender=user1.username, reciever=user2.username, gameId=gameId)
    Game.objects.create(first=user1.username, second=user2.username, gameId=gameId)
    data = {
        "first":user1.username,
        "second":user2.username,
        "gameId":gameId
    }
    return Response(data)

@api_view(['POST'])
def ad_invite(request):
    sender = User.objects.get(username=request.data['username'])
    token = Token.objects.get(token=request.data['token'])
    reciever = User.objects.get(token=token)
    ad_request = request.data['adRequest']
    try:
        if ad_request == "delete":
            deleted = False
            try:
                if request.data['cancelled'] == True:
                    data = {
                        "result": "Cancelled"
                    }
                    return Response(data)
                else:
                    for invite in GameInvite.objects.all():
                        if invite.sender == sender.username:
                            if invite.reciever == reciever.username:
                                game = Game.objects.get(gameId=invite.gameId)
                                game.delete()
                                invite.delete()
                                deleted = True
                        elif invite.sender == reciever.username:
                            if invite.reciever == sender.username:
                                game = Game.objects.get(gameId=invite.gameId)
                                game.delete()
                                invite.delete()
                                deleted = True
                    if deleted:
                        data = {
                            "result": "Cancelled"
                        }
                    else:
                        data = {
                            "result": "Soemthing went wrong"
                        }
                    return Response(data)
            except:
                for invite in GameInvite.objects.all():
                    if invite.sender == sender.username:
                        if invite.reciever == reciever.username:
                            game = Game.objects.get(gameId=invite.gameId)
                            game.delete()
                            invite.delete()
                            deleted = True
                    elif invite.sender == reciever.username:
                        if invite.reciever == sender.username:
                            game = Game.objects.get(gameId=invite.gameId)
                            game.delete()
                            invite.delete()
                            deleted = True
                if deleted:
                    data = {
                        "result": "Cancelled"
                    }
                else:
                    data = {
                        "result": "Soemthing went wrong"
                    }
                return Response(data)
        else:
            game = None
            for invite in GameInvite.objects.all():
                if invite.sender == sender.username:
                    if invite.reciever == reciever.username:
                        game = Game.objects.get(gameId=invite.gameId)
                        invite.delete()
                        deleted = True
                elif invite.sender == reciever.username:
                    if invite.reciever == sender.username:
                        game = Game.objects.get(gameId=invite.gameId)
                        invite.delete()
                        deleted = True
            if deleted:
                data = {
                    "result": "Accepted",
                    "first":game.first,
                    "second":game.second,
                    "gameId":game.gameId
                }
            else:
                data = {
                    "result": "Soemthing went wrong"
                }
            return Response(data)
    except:
        data = {
            "result": "Somethiong went wrong"
        }
        return Response(data)

@api_view(['POST'])
def send_username(request):
    phone_number = request.data['phone_number']
    data = {
        "response": True,
        "message" : ""
    }

    try:
        user = User.objects.get(phone_number=phone_number)
        data['message'] = "BEFORE SEND TEXT"
        requests.post('https://textbelt.com/text', {
            'phone': phone_number,
            'message': f'Your username is: {user.username}',
            'key': '0d40a9c1f04d558428eb525db9b4502e0a15cd31F5JAs5vP0Yc2JcS2TzrtsqFKd',
        })
        data['message'] = "RESPONSE IS A SUCCESS"
    except Exception as e:
        data['response'] = False
        data['message'] = f"IN THE EXCEPT BLOCK e: {e}"
    
    return Response(data)

@api_view(['POST'])
def send_code(request):
    phone_number = request.data['phone_number']
    code = ""

    for i in range(4):
        num = randrange(10)
        code += str(num)
    data = {
        "response": True,
        "code" : code
    }

    try:
        user = User.objects.get(phone_number=phone_number)
        data['message'] = "BEFORE SEND TEXT"
        requests.post('https://textbelt.com/text', {
            'phone': phone_number,
            'message': f'Your temporary code is: {code}',
            'key': '951292afc50e335e0bc2ac92e70e3ecd4030853aQFJFjuPmMccnZjNCihpssKcII',
        })
        right_now = make_aware(datetime.datetime.now())
        user.p_code = int(code)
        user.p_code_time = right_now
        user.save()
        data['message'] = f"RESPONSE IS A SUCCESS {right_now}."
    except Exception as e:
        data['response'] = False
        data['message'] = f"IN THE EXCEPT BLOCK e: {e}"
    
    return Response(data)

@api_view(['POST'])
def change_password(request):
    if request.data['code'] == "SAVE":
        print("IN SAVED IF STATMENT")
        data = {
            "response": True,
            "message": "",
            "error_type": 0
        }
        try:
            print("IN THE TRY BLOCK")
            password = request.data['password']
            if password.strip() == "":
                data["response"] = False
                data["error_type"] = 0
                data["message"] = "Password can't be blank."
                return Response(data)
            print("AFTER CHECKING FOR EMPTY")
            token = Token.objects.get(token=request.data['token'])
            user = User.objects.get(token=token)
            print("GOT USER")
            newPW = bcrypt.hashpw(password.encode(config('ENCODE')), user.password.encode(config('ENCODE')))
            print("GOT NEW PW")
            if newPW == user.password.encode(config('ENCODE')):
                print("PASSWORD IS PREVIOUS PASSWORD")
                data["response"] = False
                data["error_type"] = 1
                data["message"] = "Password can't be previous password."
                print(data)
                return Response(data)
            print("PASSWORDS ARE DIFFERENT")
            salt = bcrypt.gensalt(rounds=config('ROUNDS', cast=int))
            print("GOT THE SALT")
            hashed = bcrypt.hashpw(password.encode(config('ENCODE')), salt).decode()
            print("GOT THE HASHED")
            user.password = hashed
            print("SET USER PASSWORD")
            user.is_guest = False
            print("SET THE GUEST")
            user.save()
        except:
            print("IN EXCEPT BLOCK")
            data["response"] = False
            data["error_type"] = 3
            data["message"] = "Something went wrong."
        return Response(data)
    elif request.data['code'] == "Change_Password":
        print("IN Change_Password IF STATMENT")
        data = {
            "response": True,
            "message": "",
            "error_type": 0,
            "expired": False
        }
        try:
            print("IN THE TRY BLOCK")
            password = request.data['password']
            if password.strip() == "":
                data["response"] = False
                data["error_type"] = 0
                data["message"] = "Password can't be blank."
                return Response(data)
            print("AFTER CHECKING FOR EMPTY")
            user = User.objects.get(username=request.data['username'])
            print("GOT USER")
            newPW = bcrypt.hashpw(password.encode(config('ENCODE')), user.password.encode(config('ENCODE')))
            print("GOT NEW PW")
            if newPW == user.password.encode(config('ENCODE')):
                print("PASSWORD IS PREVIOUS PASSWORD")
                data["response"] = False
                data["error_type"] = 1
                data["message"] = "Password can't be previous password."
                print(data)
                return Response(data)
            print("PASSWORDS ARE DIFFERENT")
            salt = bcrypt.gensalt(rounds=config('ROUNDS', cast=int))
            print("GOT THE SALT")
            hashed = bcrypt.hashpw(password.encode(config('ENCODE')), salt).decode()
            print("GOT THE HASHED")
            user.password = hashed
            print("SET USER PASSWORD")
            user.is_guest = False
            print("SET THE GUEST")
            user.save()
            data["response"] = True
            data["error_type"] = 0
            data["message"] = "Success"
            data['expired'] = False
        except:
            print("IN EXCEPT BLOCK")
            data["response"] = False
            data["error_type"] = 3
            data["message"] = "Something went wrong."
        print("DATA IS BELOW")
        print(data)
        return Response(data)
    data = {
        "response": True,
        "expired": False,
        "message": "",
        "error_type": 0
    }
    code = request.data['code']
    password = request.data['password']
    if password.strip() == "":
        data["response"] = False
        data["error_type"] = 0
        data["message"] = "Password can't be blank."
        data["expired"] = False
        return Response(data)
    user = User.objects.get(p_code=int(code))
    ser_data = {
        "username": user.username,
        "password": password
    }
    newPW = bcrypt.hashpw(password.encode(config('ENCODE')), user.password.encode(config('ENCODE')))
    if newPW == user.password.encode(config('ENCODE')):
        data["response"] = False
        data["error_type"] = 1
        data["message"] = "Password can't be previous password."
        data["expired"] = False
        return Response(data)
    p_word_datetime_limit = user.p_code_time + timedelta(minutes=5)
    right_now = make_aware(datetime.datetime.now())
    try:
        if p_word_datetime_limit > right_now:
            salt = bcrypt.gensalt(rounds=config('ROUNDS', cast=int))
            hashed = bcrypt.hashpw(password.encode(config('ENCODE')), salt).decode()
            user.password = hashed
            user.save()
            data['message'] = f"Successfully saved password."
        else:
            data["response"] = False
            data['message'] = "Time limit reached. Invalid code."
            data["error_type"] = 2
            data['expired'] = True
    except:
        data['response'] = False
        data["error_type"] = 3
        data['message'] = "Something went wrong."
        data['expired'] = False

    return Response(data)
        
@api_view(['POST'])
def save(request):
    print("IN SAVE")
    data = {
        "response" : ""
    }

    try:
        print("IN TRY BLOCK")
        print(request.data['question_1'])
        print(request.data['question_2'])
        print(request.data['answer_1'])
        print(request.data['answer_2'])
        print(request.data['edit_qnas'])
        token = Token.objects.get(token=request.data['token'])
        print("CREATED TOKEN")
        user = User.objects.get(token=token)
        print("FOUND USER")
        for u in User.objects.all():
            if u.username == request.data['username']:
                if u != user:
                    print("INVALID USERNAME")
                    data['response'] = "Invalid username."
                    return Response(data)
        print("SAVING DATA")
        user.first_name = request.data['first_name']
        print("SAVED FIRST NAME")
        user.last_name = request.data['last_name']
        print("SAVED LAST NAME")
        user.username = request.data['username']
        print("SAVED USERNAME")
        user.phone_number = request.data['phone_number']
        print("SAVED PHONE NUMBER")
        user.save()
        print("SAVED")
        if request.data['edit_qnas']:
            print("EDITING QUESTIONS AND ANSWERS")
            users_qnas = user.security_questions_answers
            users_qnas.question_1 = request.data['question_1']
            users_qnas.question_2 = request.data['question_2']
            users_qnas.answer_1 = request.data['answer_1']
            users_qnas.answer_2 = request.data['answer_2']
            users_qnas.save()
            user.save()
            print("SAVED EVERYTHING HERE")
        if request.data['guest']:
            print("IS A GUEST")
            data['response'] = "Guest"
        else:
            print("IS NOT A GUEST")
            data['response'] = "Successfully saved data."
    except Exception as e:
        print("E IS BELOW")
        print(e)
        data['response'] = "Something went wrong: " + e

    return Response(data)

@api_view(['POST'])
def save_wallet(request):
    try:
      wallet_address = request.data['wallet']
      if wallet_address != "None":
        if config('IS_HEROKU_ENV', cast=bool):
          # Verify if the connection is successful
          if w3.is_connected():
            print("-" * 50)
            print("Connection Successful")
            print(w3.eth.chain_id)
            print(w3.eth.gas_price)
            print(w3.eth.block_number)
            print("-" * 50)
            print("THE WALLET ADDRESS IS BELOW")
            print(wallet_address)
            # Load the contract ABI and address
            contract_address = contract_address_const
            # contract_address = config('CONTRACT_ADDRESS')  # Replace with your contract address
            contract_abi = contract_abi_const
            print("SET THE CONTRACT ADDRRESS AND ABI")

            # # Create a contract object
            contract = w3.eth.contract(address=contract_address, abi=contract_abi)
            print("CREATED THE CONTRACT VARIABLE")
            function_to_call = contract.functions.addWallet(wallet_address, "TEMPORARYADDWALLETPASSCODE")
            print("AFTER FUNCTION TO CALL")
            # Build the transaction
            transaction = function_to_call.build_transaction({
                "chainId": 5,  # Replace with the appropriate chain ID
                "gasPrice": w3.to_wei('50', 'gwei'),  # Set the gas price as needed
                "gas": 200000,  # Set the gas limit as needed
                "nonce": w3.eth.get_transaction_count("0x078893aE92b2e866464E9853da549304C4dB3e28"),
            })
            print("AFTER MAKING THE TRANSACTION")
            # Sign the transaction
            signed_transaction = w3.eth.account.sign_transaction(transaction, "75029fb3adb8ca1b275cbd6d224796d1795e13f9b578e2669666796666dd4881")
            print("AFTER SIGNING THE TRANSACTION")
            # Send the transaction
            transaction_hash = w3.eth.send_raw_transaction(signed_transaction.rawTransaction)
            print("AFTER GETTING THE TRANSACTION HASH")
            # Print the transaction hash
            print("Transaction Hash:", transaction_hash)
            # Check the transaction status
            receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)
            print("Transaction Receipt:", receipt)
            print("Transaction Receipt STATUS:", receipt["status"])
            # Interact with the contract (e.g., call functions)
            result = contract.functions.checkForUser("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
            result2 = contract.functions.checkForUser("0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7").call()
            print("RESULT IS BELOW")
            print(result)
            print("RESULT2 IS BELOW")
            print(result2)
            if result:
              data = {
                  "response": "SUCCESS"
              }
            else:
              data = {
                "response": "FAILURE"
              }
            return Response(data)
          else:
            print("Connection Failed")
            data = {
              "response": "FAILURE"
            }
            return Response(data)
        else:
          if w3.isConnected():
            print("-" * 50)
            print("Connection Successful")
            print(w3.eth.chain_id)
            print(w3.eth.gas_price)
            print(w3.eth.block_number)
            print("-" * 50)
            print("THE WALLET ADDRESS IS BELOW")
            print(wallet_address)
            # Load the contract ABI and address
            contract_address = contract_address_const
            # contract_address = config('CONTRACT_ADDRESS')  # Replace with your contract address
            contract_abi = contract_abi_const
            print("SET THE CONTRACT ADDRRESS AND ABI")

            # # Create a contract object
            contract = w3.eth.contract(address=contract_address, abi=contract_abi)
            print("CREATED THE CONTRACT VARIABLE")
            account = ''
            if request.data['isUserOne'] == True:
                account = '0x078893aE92b2e866464E9853da549304C4dB3e28'
            else:
                account = '0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7'
            function_to_call = contract.functions.addWallet(account, "TEMPORARYADDWALLETPASSCODE")
            print("AFTER FUNCTION TO CALL")
            # Build the transaction
            transaction = function_to_call.buildTransaction({
                "chainId": 5,  # Replace with the appropriate chain ID
                "gasPrice": w3.toWei('50', 'gwei'),  # Set the gas price as needed
                "gas": 200000,  # Set the gas limit as needed
                "nonce": w3.eth.getTransactionCount("0x078893aE92b2e866464E9853da549304C4dB3e28"),
            })
            print("AFTER MAKING THE TRANSACTION")
            # Sign the transaction
            signed_transaction = w3.eth.account.signTransaction(transaction, "75029fb3adb8ca1b275cbd6d224796d1795e13f9b578e2669666796666dd4881")
            print("AFTER SIGNING THE TRANSACTION")
            # Send the transaction
            transaction_hash = w3.eth.sendRawTransaction(signed_transaction.rawTransaction)
            print("AFTER GETTING THE TRANSACTION HASH")
            # Print the transaction hash
            print("Transaction Hash:", transaction_hash)
            # Check the transaction status
            receipt = w3.eth.waitForTransactionReceipt(transaction_hash)
            print("Transaction Receipt:", receipt["status"])
            # Interact with the contract (e.g., call functions)
            result = contract.functions.checkForUser("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
            print("RESULT IS BELOW")
            print(result)
            if result:
              data = {
                  "response": "SUCCESS"
              }
            else:
              data = {
                "response": "FAILURE"
              }
            return Response(data)
          else:
            print("Connection Failed")
            data = {
              "response": "FAILURE"
            }
            if wallet_address == "0x078893aE92b2e866464E9853da549304C4dB3e28":
                data["wallet_address"] = True
            else:
                data["wallet_address"] = False
            return Response(data)   
    except Exception as e:
      print("IN THE EXCEPT BLOCK")
      print(e)
      data = {
        "response": "Something went wrong."
      }
      return Response(data)

@api_view(['POST'])
def pass_face_id(request):
    try:
      if config('IS_HEROKU_ENV', cast=bool):
        if w3.is_connected():        
          print("-" * 50)
          print("Connection Successful")
          print(w3.eth.chain_id)
          print(w3.eth.gas_price)
          print(w3.eth.block_number)
          print("-" * 50)
          contract_address = contract_address_const
          # contract_address = config('CONTRACT_ADDRESS')  # Replace with your contract address
          contract_abi = contract_abi_const
          print("SET THE CONTRACT ADDRRESS AND ABI")
          # # Create a contract object
          contract = w3.eth.contract(address=contract_address, abi=contract_abi)
          account = ''
          if request.data['isUserOne'] == True:
              account = '0x078893aE92b2e866464E9853da549304C4dB3e28'
          else:
              account = '0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7'
          print("CREATED THE CONTRACT VARIABLE")
          function_to_call = contract.functions.faceIdCheck(account, "TEMPORARYFACEIDCODE", 10000)
          print("AFTER FUNCTION TO CALL")
          # Build the transaction
          transaction = function_to_call.build_transaction({
              "chainId": 5,  # Replace with the appropriate chain ID
              "gasPrice": w3.to_wei('50', 'gwei'),  # Set the gas price as needed
              "gas": 200000,  # Set the gas limit as needed
              "nonce": w3.eth.get_transaction_count("0x078893aE92b2e866464E9853da549304C4dB3e28"),
          })
          print("AFTER MAKING THE TRANSACTION")
          # Sign the transaction
          signed_transaction = w3.eth.account.sign_transaction(transaction, "75029fb3adb8ca1b275cbd6d224796d1795e13f9b578e2669666796666dd4881")
          print("AFTER SIGNING THE TRANSACTION")
          # Send the transaction
          transaction_hash = w3.eth.send_raw_transaction(signed_transaction.rawTransaction)
          print("AFTER GETTING THE TRANSACTION HASH")
          # Print the transaction hash
          print("Transaction Hash:", transaction_hash)
          # Check the transaction status
          receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)
          print("Transaction Receipt:", receipt["status"])
          #checkUserFaceIdChecked
          # Interact with the contract (e.g., call functions)
          result = contract.functions.checkUserFaceIdChecked("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
          result2 = contract.functions.checkUserFaceIdChecked("0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7").call()
          print("RESULT IS BELOW")
          print(result)
          print("RESULT2 IS BELOW")
          print(result2)
          data = {
            "result": "SUCCESS"
          }
        else:
          print("Connection Failed")
          data = {
              "result": "FALIURE"
          }
      else:
        if w3.isConnected():        
          print("-" * 50)
          print("Connection Successful")
          print(w3.eth.chain_id)
          print(w3.eth.gas_price)
          print(w3.eth.block_number)
          print("-" * 50)
          contract_address = contract_address_const
          # contract_address = config('CONTRACT_ADDRESS')  # Replace with your contract address
          contract_abi = contract_abi_const
          print("SET THE CONTRACT ADDRRESS AND ABI")
          # # Create a contract object
          contract = w3.eth.contract(address=contract_address, abi=contract_abi)
          print("CREATED THE CONTRACT VARIABLE")
          function_to_call = contract.functions.faceIdCheck("0x078893aE92b2e866464E9853da549304C4dB3e28", "TEMPORARYFACEIDCODE", 10000)
          print("AFTER FUNCTION TO CALL")
          # Build the transaction
          transaction = function_to_call.buildTransaction({
              "chainId": 5,  # Replace with the appropriate chain ID
              "gasPrice": w3.toWei('50', 'gwei'),  # Set the gas price as needed
              "gas": 200000,  # Set the gas limit as needed
              "nonce": w3.eth.getTransactionCount("0x078893aE92b2e866464E9853da549304C4dB3e28"),
          })
          print("AFTER MAKING THE TRANSACTION")
          # Sign the transaction
          signed_transaction = w3.eth.account.signTransaction(transaction, "75029fb3adb8ca1b275cbd6d224796d1795e13f9b578e2669666796666dd4881")
          print("AFTER SIGNING THE TRANSACTION")
          # Send the transaction
          transaction_hash = w3.eth.sendRawTransaction(signed_transaction.rawTransaction)
          print("AFTER GETTING THE TRANSACTION HASH")
          # Print the transaction hash
          print("Transaction Hash:", transaction_hash)
          # Check the transaction status
          receipt = w3.eth.waitForTransactionReceipt(transaction_hash)
          print("Transaction Receipt:", receipt["status"])
          #checkUserFaceIdChecked
          # Interact with the contract (e.g., call functions)
          result = contract.functions.checkUserFaceIdChecked("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
          print("RESULT IS BELOW")
          print(result)
          data = {
            "result": "SUCCESS"
          }
        else:
          print("Connection Failed")
          data = {
              "result": "FALIURE"
          }
          
      return Response(data)
    except Exception as e:
        print("IN THE EXCEPT BLOCK")
        print(e)
        data = {
            "result": "Something went wrong."
        }
        return Response(data)

@api_view(['GET'])   
def get_security_questions(request):
    try:
        all_security_questions = SecurityQuestionsText.objects.all()
        count = 0
        options1 = []
        options2 = []
        for q in all_security_questions:
            if count < 4:
                options1.append(q.text)
            else:
                options2.append(q.text)
            count+=1
        data={
            "options_1": options1,
            "options_2": options2
        }
        print("GOT BOTH OPTIONS")
        print(options1)
        print(options2)
        return Response(data)
    except:
        print("SOMETHING WENT WRING")
        data={
            "options_1": "Nothing",
            "options_2": "Nothing"
        }
        return Response(data)

@api_view(['POST'])
def save_users_security_questions(request):
    try:
        print("SAVING USERS SECURITY QUESTIONS")
        print(request.data['question_1'])
        print(request.data['answer_1'])
        print(request.data['question_2'])
        print(request.data['answer_2'])
        new_security_question_object = UsersSecurityQuestionsAnswers.objects.create(
            question_1=request.data['question_1'],
            answer_1=request.data['answer_1'],
            question_2=request.data['question_2'],
            answer_2=request.data['answer_2']
        )

        token = Token.objects.get(token=request.data['token'])
        user = User.objects.get(token=token)

        user.security_questions_answers = new_security_question_object
        user.save()
        data = {
            "result": "Success"
        }
        return Response(data)
    except:
        data ={
            "result": "Failure"
        }
        return Response(data)

@api_view(['POST'])
def check_has_questions(request):
    try:
        print("IN THE TRY BLOCK")
        user = User.objects.get(username=request.data['username'])
        print("GOT THE USER")
        if user.security_questions_answers == None:
            print("USER HAS NO QUESTIONS")
            data = {
                "result": "User has no questions.",
                "question_1": "None",
                "question_2": "None",
            }
            return Response(data)
        else:
            print("USER HAS QUESTIONS")
            print(user.security_questions_answers)
            print("GOT THE USERS QUESTIONS OBJECT BY ID")
            data = {
                "result": "Success",
                "question_1": user.security_questions_answers.question_1,
                "question_2": user.security_questions_answers.question_2,
            }
            return Response(data)
    except:
        print("IN THE EXCEPT BLOCK")
        data = {
            "result": "Something went wrong.",
            "question_1": "None",
            "question_2": "None",
        }
        return Response(data)

@api_view(['POST'])
def check_users_answers(request):
    try:
        user = User.objects.get(username=request.data['username'])
        if user.security_questions_answers.answer_1 == request.data['answer_1']:
            if user.security_questions_answers.answer_2 == request.data['answer_2']:
                print("CORRECT ANSWERS")
                data = {
                    "result": True
                }
                return Response(data)
        print("InCORRECT ANSWERS")
        data = {
            "result": False
        }
        return Response(data)
    except:
        print("In Except Block")
        data = {
            "result": False
        }
        return Response(data)

@api_view(['POST'])
def get_users_questions_answers(request):
    print("IN GETTING THE USERS Q AND A FUNCTION")
    print("IN GETTING THE USERS Q AND A FUNCTION")
    print("IN GETTING THE USERS Q AND A FUNCTION")
    print("IN GETTING THE USERS Q AND A FUNCTION")
    try:
        print("IN THE TRY BLOCK")
        token = Token.objects.get(token=request.data['token'])
        user = User.objects.get(token=token)
        print("GOT THE USER")
        if user.security_questions_answers == None:
            print("USER HAS NO QUESTIONS")
            data = {
                "result": "User has no questions.",
                "question_1": "None",
                "question_2": "None",
                "answer_1": "None",
                "asnwer_2": "None"
            }
            return Response(data)
        else:
            print("USER HAS QUESTIONS")
            print(user.security_questions_answers)
            print("GOT THE USERS QUESTIONS OBJECT BY ID")
            data = {
                "result": "Success",
                "question_1": user.security_questions_answers.question_1,
                "question_2": user.security_questions_answers.question_2,
                "answer_1": user.security_questions_answers.answer_1,
                "answer_2": user.security_questions_answers.answer_2
            }
            return Response(data)
    except:
        print("IN THE EXCEPT BLOCK")
        data = {
            "result": "Something went wrong.",
            "question_1": "None",
            "question_2": "None",
            "answer_1": "None",
            "asnwer_2": "None"
        }
        return Response(data)

@api_view(['POST'])
def save_location(request):
    try:
        print("IN THE TRY BLOCK")
        print(request.data['latitude'])
        print(request.data['longitude'])
        print(request.data['timezone'])
        token = Token.objects.get(token=request.data['token'])
        print("GOT THE TOKEN")
        user = User.objects.get(token=token)
        print("GOT THE USER")
        user.user_latitude = request.data['latitude']
        print("GOT LATITUDE")
        user.user_longitude = request.data['longitude']
        print("SET THE COORDINATES")
        user.user_time_zone = request.data['timezone']
        print("SET THE TIME ZONE")
        user.has_location = True
        print("USER LOCATION IS TRUE")
        user.save()
        print("SAVED USER")
        data = {
            "result" : "SUCCESS"
        }
        print("RETURNING SUCCESS")
        return Response(data)
    except:
        print("SOMETHING WENT WRONG")
        data = {
            "result" : "Something went wrong."
        }
        return Response(data)

def sort_leaderboard(e):
    print("E IS BELOW")
    print(e)
    return e['win_percentage']

@api_view(['GET']) 
def get_leaderboard_data(request):
    print("IN GET LEADERBOARD DATA")
    try:
        print("IN THE TRY")
        all_users = User.objects.all()
        print("GOT ALL USERS")
        all_users_adjusted = []
        for user in all_users:
            print("GETTING USER BELOW")
            print(user.username)
            total_games = user.wins + user.losses
            print("GOT TOTAL GAMES BELOW")
            print(total_games)
            if total_games > 0:
                win_percentage = user.wins / total_games
                win_percentage = win_percentage * 100
            else:
                win_percentage = 0
            print("GOT WIN PERCENTAGE")
            print(win_percentage)
            user_obj = {
                "username": user.username,
                "wins": user.wins,
                "losses": user.losses,
                "win_percentage" : win_percentage,
                "total_games": total_games,
                "league": user.league
            }
            print("CREATED USER OBJ")
            print(user_obj)
            all_users_adjusted.append(user_obj)
            print("APPENDED USER TO LIST")
        print("GOT ALL USERS ADJUSTED LIST")
        print(all_users_adjusted)
        all_users_adjusted.sort(key=sort_leaderboard, reverse=True)
        data = {
            "result": "Success",
            "all_users":all_users_adjusted
        }
        return Response(data)
    except Exception as e:
        print("SOMETHING WENT WRONG")
        print(e)
        data = {
            "result": "Something went wrong.",
            "all_users": []
        }
        return Response(data)

def update_players_wins():
  print("***** IN THE UPDATE PLAYERS WINS FUNCTION *****")
  print("***** IN THE UPDATE PLAYERS WINS FUNCTION *****")
  print("***** IN THE UPDATE PLAYERS WINS FUNCTION *****")
  try:
    if w3.is_connected():        
      print("-" * 50)
      print("Connection Successful")
      print(w3.eth.chain_id)
      print(w3.eth.gas_price)
      print(w3.eth.block_number)
      print("-" * 50)
      account2 = '0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7'
      contract_address = contract_address_const
      # contract_address = config('CONTRACT_ADDRESS')  # Replace with your contract address
      contract_abi = contract_abi_const
      print("SET THE CONTRACT ADDRRESS AND ABI")
      # # Create a contract object
      contract = w3.eth.contract(address=contract_address, abi=contract_abi)
      print("CREATED THE CONTRACT VARIABLE")
      function_to_call = contract.functions.updatePlayersWins("0x078893aE92b2e866464E9853da549304C4dB3e28", account2, 10000, 10000, 70)
      print("AFTER FUNCTION TO CALL")
      # Build the transaction
      transaction = function_to_call.build_transaction({
          "chainId": 5,  # Replace with the appropriate chain ID
          "gasPrice": w3.to_wei('50', 'gwei'),  # Set the gas price as needed
          "gas": 200000,  # Set the gas limit as needed
          "nonce": w3.eth.get_transaction_count("0x078893aE92b2e866464E9853da549304C4dB3e28"),
      })
      print("AFTER MAKING THE TRANSACTION")
      # Sign the transaction
      signed_transaction = w3.eth.account.sign_transaction(transaction, "75029fb3adb8ca1b275cbd6d224796d1795e13f9b578e2669666796666dd4881")
      print("AFTER SIGNING THE TRANSACTION")
      # Send the transaction
      transaction_hash = w3.eth.send_raw_transaction(signed_transaction.rawTransaction)
      print("AFTER GETTING THE TRANSACTION HASH")
      # Print the transaction hash
      print("Transaction Hash:", transaction_hash)
      # Check the transaction status
      receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)
      print("Transaction Receipt:", receipt["status"])
      #checkUserFaceIdChecked
      # Interact with the contract (e.g., call functions)
      # returnWinningsAmount
      result = contract.functions.getUserStreakBoard("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
      result2 = contract.functions.returnWinningsAmount().call()
      result3 = contract.functions.getUserStreakBoard("0x60F4a7E61B3f675C08b682204D93e5E42b6bd2c7").call()
      result4 = contract.functions.get_test_var().call()
      print("RESULT IS BELOW")
      print(result)
      print("RESULT2 BELOW")
      print(result2)
      print("RESULT3 BELOW")
      print(result3)
      print("RESULT 4 BELOW")
      print(result4)
    data = {
      "result": "NOTDEVENVIORNMENT"
    }
    return Response(data)
  except Exception as e:
    print("IN THE EXCEPT BLOCK")
    print(e)
    data = {
        "result": "Something went wrong."
    }
    return Response(data)

def league_placement(wins, games):
    print("IN LEAGUE PLACEMENT FUNCTION")
    percentage = (wins / games) * 100
    print("THE PERCENTAGE IS: ", percentage)
    str_percentage = str(percentage)
    print("STRING PERCENTAGE IS: ", str_percentage)
    if "." in str_percentage:
        print("HAS DECIMAL")
        new_percentage = str_percentage.split(".")[0]
        print("NEW_PERCENTAGE: ", new_percentage)
        percentage = int(new_percentage)
        print("NEW PERCENTAGE CONVERTED TO INT: ", percentage)
    if percentage <= 35:
        print("IS A NOOB PLAYER")
        return LeagueEnum.NOOB_TAPPER.value
    elif percentage <= 43:
        print("IS A BAD PLAYER")
        return LeagueEnum.BAD_TAPPER.value
    elif percentage <= 51:
        print("IS AN OKAY PLAYER")
        return LeagueEnum.OKAY_TAPPER.value
    elif percentage <= 59:
        print("IS A BETTER PLAYER")
        return LeagueEnum.BETTER_TAPPER.value
    elif percentage <= 67:
        print("IS A GOOD PLAYER")
        return LeagueEnum.GOOD_TAPPER.value
    elif percentage <= 75:
        print("IS A SOLID PLAYER")
        return LeagueEnum.SOLID_TAPPER.value
    elif percentage <= 83:
        print("IS A SUPER PLAYER")
        return LeagueEnum.SUPER_TAPPER.value
    elif percentage <= 91:
        print("IS A MEGA PLAYER")
        return LeagueEnum.MEGA_TAPPER.value
    elif percentage > 91:
        print("IS A GODLY PLAYER")
        return LeagueEnum.GODLY_TAPPER.value
    else:
        print("IS A NOOB PLAYER IN THE LESE STATEMENT")
        return LeagueEnum.NOOB_TAPPER.value

    


##################################################################################################################################################
##################################################################################################################################################
##################################### OTHER CODE TO USE BELOW #############################################################################################################
##################################################################################################################################################
##################################################################################################################################################
# Interact with the contract (e.g., call functions)
# result = contract.functions.checkForUser("0x078893aE92b2e866464E9853da549304C4dB3e28").call()
# print("RESULT IS BELOW")
# print(result)